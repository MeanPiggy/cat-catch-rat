<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="author" content="Jongjai Lochman">
	<title>Cat Catch Rat</title>

	<style>
		body{
			font-family:Helvetica;
			text-align:center;
		}
		.wrap{
			width: 100%;
		    text-align: center;
		    display: block;
		    overflow: hidden;
		    height: 480px;
		    position: absolute;
		    left: 0;
		}
		#game-over{
			position:relative;
			z-index:9999;
			background:rgba(0,0,0,0.5);
			width:512px;
			height:480px;
			color:#fff;
			text-align:center;
			display:none;
			margin:auto;
		}
		#game-over.active{
			display:table;
		}
		.center-text{
			display:table-cell;
			vertical-align:middle;
			text-align:center;
		}
		#reset{
			padding:10px;
			background:orange;
			margin-top:15px;
			display:inline-block;
			cursor:pointer;
		}
		#reset:hover{
			background:#999;
		}
	</style>
	
</head>

<body>
	<h1>Cat Catch Rat</h1>

	<p><b>How to play</b> : To catch the rat use arrow left, right, up and down on your keyboard to move the cat. 
		Try to avoid the cars and the hole on the road. Have fun!!</p>

	<div class="wrap">
		<div id="game-over">
			<div class="center-text">
				<h2>Game Over</h2>
				<div id="reset">Restart</div>
			</div>
		</div>	
	</div>

	<script>
		// Create the canvas 
		var canvas = document.createElement("canvas");
		canvas.width = 512;
		canvas.height = 480;
		var ctx = canvas.getContext("2d");
		document.body.appendChild(canvas);

		// Background image
		var bgReady = false;
		var bgImage = new Image();
		bgImage.onload = function () {
			bgReady = true;
		};
		bgImage.src = "images/background.png";

		// Cat image
		var catReady = false;
		var catImage = new Image();
		catImage.onload = function() {
			catReady = true;
		};
		catImage.src = "images/cat.png";

		// Rat image
		var ratReady = false;
		var ratImage = new Image();
		ratImage.onload = function() {
			ratReady = true;
		};
		ratImage.src = "images/rat.png";

		// Hole image
		var holeReady = false;
		var holeImage = new Image();
		holeImage.onload = function() {
			holeReady = true;
		};
		holeImage.src = "images/hole.png";

		// Car image
		var carReady = false;
		var carImage = new Image();
		carImage.onload = function() {
			carReady = true;
		};
		carImage.src = "images/car.png"; 

		// Sound Effects
		var ratSound = new sound("sounds/rat-hit.mp3");
		var catSound = new sound("sounds/cat-hit.mp3");

		// Game objects position
		var cat = {
			speed: 256,
			x: canvas.width / 2,
			y: canvas.height / 2
		};

		var rat = {
			x: 32 + (Math.random() * (canvas.width - 64)),
			y: 32 + (Math.random() * (canvas.height - 64))
		};
		
		var isRatHurt = false;

		var hole = {
			x: 32 + (Math.random() * (canvas.width - 64)),
			y: 32 + (Math.random() * (canvas.height - 64))
		};
		
		var cars = [];
		for (var i = 0; i < 5; i++) {
			var car = {
				x: 32 + (Math.random() * (canvas.height - 64)),
				y: 1
			};
			cars.push(car);
		}
		
		var ratsCaught = 0;

		// Play sound function
		function sound(src) {
		    this.sound = document.createElement("audio");
		    this.sound.src = src;
		    this.sound.setAttribute("preload", "auto");
		    this.sound.setAttribute("controls", "none");
		    this.sound.style.display = "none";
		    document.body.appendChild(this.sound);
		    this.play = function(){
		        this.sound.play();
		    }
		    this.stop = function(){
		        this.sound.pause();
		    }
		}

		// Handle keyboard controls
		var keysDown = {};

		addEventListener("keydown", function (e) {
			keysDown[e.keyCode] = true;
		}, false);

		addEventListener("keyup", function (e) {
			delete keysDown[e.keyCode];
		}, false);

		// Random rat position
		function ratPosition() {
				ratImage.src = "images/rat.png";
				isRatHurt = false;
				do {
					rat.x = 32 + (Math.random() * (canvas.width - 64));
					rat.y = 32 + (Math.random() * (canvas.height - 64));
				}while(catClashRat());
				
		};

		// Random hole position
		function holePosition() {
			do {
				hole.x = 32 + (Math.random() * (canvas.width - 64));
				hole.y = 32 + (Math.random() * (canvas.height - 64));
				}while(catClashHole());
		};

		// Moving cars down
		function carMove(car) {
			if((car.y) <= 470){
				car.y += 1; 
			}else{
				car.y = 1;
				car.x = 32 + (Math.random() * (canvas.height - 64));
			}
		}

		var carSpeed = [10, 15, 20, 30, 40];
		
		function createInterval(f,dynamicParameter,interval) { 
			setInterval(function() { f(dynamicParameter); }, interval);
		} 

		for (var i = 0; i < 5; i++) {
			createInterval(carMove, cars[i], carSpeed[i]);
		}

		

		// Random position for Rat and Hole
		var ratInterval = 0;
		var holeInterval = 0;

		// Reset the game when the player catches a rat
		function reset() {
			// Loop every few seconds change the position by random
			var ratMoveLoop = function() {
				if(ratInterval > 0) clearInterval(ratInterval);
				ratInterval = setInterval(function(){ratPosition();}, 3000);
			}
			ratMoveLoop();

			var holeMoveLoop = function() {
				if(holeInterval > 0) clearInterval(holeInterval);
				holeInterval = setInterval(function(){holePosition();}, 2000);
			}
			holeMoveLoop();
		};
		
		// Update game objects
		gameOverOnce = true;
		function update(modifier) {
			if (38 in keysDown) {// Player holding up
				cat.y -= cat.speed * modifier;
				if (gameOverOnce){
					if(cat.y < 0){
						cat.y = 0;
					}
				}
			}
			if (40 in keysDown) {// Player holding down
				cat.y += cat.speed * modifier;
				if(cat.y > 448){
					cat.y = 448;
				}
			}
			if (37 in keysDown) {// Player holding left
				cat.x -= cat.speed * modifier;
				if(cat.x < 0){
					cat.x = 0;
				}
			}
			if (39 in keysDown) {// Player holding right
				cat.x += cat.speed * modifier;
				if(cat.x > 480){
					cat.x = 480;
				}
			}

			// Is cat touching rat?
			if (catClashRat()) {
				ratImage.src = "images/rat2.png";
				++ratsCaught;
				isRatHurt = true;
				ratSound.play();
				setTimeout(function() {ratPosition();}, 300);
				reset();
				
			}

			// Is cat touch car or hole?
			if (catClashHole() || catClashAnyCars()) {
				if (gameOverOnce) {
					catSound.play();
					clearInterval(ratInterval);
					var gameOver = document.getElementById("game-over");
					gameOver.classList.add("active");

					// Restart the game
					document.getElementById("reset").addEventListener("click", function() {
						location.reload();
					});	

					cat.speed = 0;
					cat.x = -32;
					cat.y = -32;
					gameOverOnce = false;
				}

				// Enter to to Restart
				var enterDown = false;
				document.addEventListener('keydown', function (e){
					if(e.keyCode == 13){
				    	enterDown = true;
					}
				}, false);

				document.addEventListener('keyup', function (e){
				    if(enterDown){
				        location.reload();
				    }
				    enterDown = false;
				}, false);

			}
			
		};
		
		// Cat touch object
		function catClash(object) {
			return (cat.x <= (object.x + 32) && object.x <= (cat.x + 32) && cat.y <= (object.y + 32) && object.y <= (cat.y + 32));
		}

		// Cat touch rat
		function catClashRat() {
			return catClash(rat);
		}

		// Cat touch hole
		var catClashHole = function() {
			return catClash(hole);
		}

		// Cat touch a car
		function catClashAnyCars(){
			for(var i = 0; i < 5; i++){
				if(catClash(cars[i])){
					return true;
				}
			}
			return false;
		}

		// Draw everything
		function render() {
		
			if (bgReady) {
				ctx.drawImage(bgImage, 0, 0);
			}
			if (catReady) {
				ctx.drawImage(catImage, cat.x, cat.y);
			}
			if (ratReady) {
				ctx.drawImage(ratImage, rat.x, rat.y);
			}
			if (holeReady) {
				ctx.drawImage(holeImage, hole.x, hole.y);
			}
			if (carReady) {
				for(var i = 0; i < 5; i++){
					ctx.drawImage(carImage, cars[i].x, cars[i].y);
				}
			}
		
			// Score
			ctx.fillStyle = "rgb(0, 0, 0)";
			ctx.font = "24px Helvetica";
			ctx.textAlign = "left";
			ctx.textBaseline = "top";
			ctx.fillText("Rat caught: " + ratsCaught, 32, 32);
		};

		// The main game loop
		function main() {
			var now = Date.now();
			var delta = now - then;

			if (!isRatHurt) {
				update(delta / 1000);
			}
			render();
			then = now;

			// Request to do this again ASAP
			requestAnimationFrame(main);
		};

		// Cross-browser support for requestAnimationFrame
		var w = window;
		requestAnimationFrame = w.requestAnimationFrame || w.webkitRequestAnimationFrame || w.msRequestAnimationFrame || w.mozRequestAnimationFrame;

		// let's Play this game
		var then = Date.now();
		reset();

		main();

		
	</script>


</body>

</html>
